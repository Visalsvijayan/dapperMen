<%- include("../../views/partials/user/header") %>
<style>
 :root {
   --primary-color: #487379;
   --secondary-color: #ADD8E6;
   --accent-color: #00bfff;
   --text-color: #333;
   --light-bg: #f8f9fa;
   --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
 }
 
 body {
   font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
   color: var(--text-color);
   background-color: var(--light-bg);
 }
 
 .main {
   padding: 30px 0;
 }
 
 .dashboard-container {
   display: flex;
   gap: 30px;
 }
 
 .dashboard-menu {
   flex: 0 0 250px;
   background-color: white;
   border-radius: 10px;
   padding: 20px 0;
   box-shadow: var(--card-shadow);
   height: fit-content;
 }
 
 .dashboard-menu .nav {
   display: flex;
   flex-direction: column;
   gap: 5px;
 }
 
 .dashboard-menu .nav-link {
   padding: 12px 20px;
   color: var(--text-color);
   font-weight: 500;
   border-left: 3px solid transparent;
   transition: all 0.3s ease;
   display: flex;
   align-items: center;
 }
 
 .dashboard-menu .nav-link i {
   margin-right: 10px;
   font-size: 18px;
 }
 
 .dashboard-menu .nav-link:hover,
 .dashboard-menu .nav-link.active {
   color: var(--accent-color);
   background-color: rgba(0, 191, 255, 0.05);
   border-left-color: var(--accent-color);
 }
 
 .dashboard-content {
   flex: 1;
 }
 
 .card {
   border: none;
   border-radius: 10px;
   box-shadow: var(--card-shadow);
   margin-bottom: 25px;
   overflow: hidden;
 }
 
 .card-header {
   background-color: var(--primary-color);
   color: white;
   padding: 15px 20px;
   font-weight: 600;
 }
 
 .card-body {
   padding: 25px;
   background-color: white;
 }
 
 .card-green {
   background-color: var(--secondary-color);
 }
 
 .btn-success {
   background-color: var(--primary-color);
   border: none;
   padding: 8px 20px;
   transition: all 0.3s ease;
 }
 
 .btn-success:hover {
   background-color: #3a5c61;
   transform: translateY(-2px);
 }
 
 .btn-primary {
   background-color: var(--accent-color);
   border: none;
 }
 
 .breadcrumb-wrap {
   background-color: white;
   padding: 15px 0;
   box-shadow: 0 2px 5px rgba(0,0,0,0.05);
 }
 
 .breadcrumb {
   padding: 0;
   margin: 0;
   background: transparent;
   font-size: 14px;
 }
 
 .breadcrumb a {
   color: var(--accent-color);
   text-decoration: none;
 }
 
 .table {
   width: 100%;
 }
 
 .table th {
   font-weight: 600;
   background-color: #f1f1f1;
 }
 
 .btn-small {
   padding: 5px 12px;
   font-size: 13px;
   border-radius: 4px;
 }
 
 .modal-content {
   border: none;
   border-radius: 10px;
   overflow: hidden;
 }
 
 @media (max-width: 992px) {
   .dashboard-container {
     flex-direction: column;
   }
   
   .dashboard-menu {
     flex: 0 0 auto;
     width: 100%;
   }
 }
 
 /* Additional improvements */
 .profile-info {
   text-align: center;
   padding: 20px 0;
 }
 
 .profile-info h5 {
   font-weight: 600;
   margin-bottom: 15px;
 }
 
 .profile-info p {
   margin-bottom: 10px;
 }
 
 .address-card {
   transition: transform 0.3s ease;
 }
 
 .address-card:hover {
   transform: translateY(-5px);
 }
 
 .action-buttons {
   display: flex;
   gap: 10px;
   margin-top: 15px;
 }
 
 .no-data {
   text-align: center;
   padding: 30px;
   color: #666;
 }
</style>

<main class="main">
 <div class="page-header breadcrumb-wrap mb-3">
   <div class="container">
     <div class="breadcrumb">
       <a href="/" rel="nofollow">Home</a>
       <span>> </span> Profile <span>> </span> Account
     </div>
   </div>
 </div>
 
 <section class="pt-10 pb-10">
   <div class="container">
     <div class="dashboard-container">
       <div class="dashboard-menu">
         <ul class="nav flex-column" role="tablist">
           <li class="nav-item">
             <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab" aria-controls="dashboard" aria-selected="false">
               <i class="fi-rs-settings-sliders mr-10"></i>Dashboard
             </a>
           </li>
           <li class="nav-item">
             <a class="nav-link" id="address-tab" data-bs-toggle="tab" href="#address" role="tab" aria-controls="address" aria-selected="true">
               <i class="fi-rs-marker mr-10"></i>My Address
             </a>
           </li>
           <li class="nav-item">
             <a class="nav-link" id="orders-tab" data-bs-toggle="tab" href="#orders" role="tab" aria-controls="orders" aria-selected="false">
               <i class="fi-rs-shopping-bag mr-10"></i>Orders
             </a>
           </li>
           <li class="nav-item">
             <a class="nav-link" id="track-orders-tab" data-bs-toggle="tab" href="#track-orders" role="tab" aria-controls="track-orders" aria-selected="false">
               <i class="fi-rs-shopping-cart-check mr-10"></i>Wallet Status
             </a>
           </li>
           <li class="nav-item">
             <a class="nav-link" id="track-orders-tab" data-bs-toggle="tab" href="#wallet-history" role="tab" aria-controls="track-orders" aria-selected="false">
               <i class="fi-rs-shopping-cart-check mr-10"></i>Wallet History
             </a>
           </li>
           <li class="nav-item">
             <a class="nav-link" id="track-orders-tab" data-bs-toggle="tab" href="#referal" role="tab" aria-controls="track-orders" aria-selected="false">
               <i class="fi-rs-shopping-cart-check mr-10"></i>Referals
             </a>
           </li>
           <li class="nav-item">
             <a class="nav-link" href="/logout">
               <i class="fi-rs-sign-out mr-10"></i>Logout
             </a>
           </li>
         </ul>
       </div>
       
       <div class="dashboard-content">
         <div class="tab-content">
           <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
             <div class="card card-green">
               <div class="card-header">
                 <h5 class="mb-0">User Profile</h5>
               </div>
               <div class="card-body profile-info">
                 <h5 class="card-title"><%=user.name%></h5>
                 <p class="card-text">
                   <strong>Phone:</strong> <%=user.phone%>
                 </p>
                 <p class="card-text">
                   <strong>Email:</strong> <%=user.email%>
                 </p>
                 <div class="mt-3">
                   <a href="" class="btn btn-success" id="change-email" data-bs-toggle="modal" data-bs-target="#edit-address-modal">Change Email</a>
                   <a href="/change-password" class="btn btn-success ms-2">Change Password</a>
                 </div>
               </div>
             </div>
           </div>

           <div class="tab-pane fade" id="address" role="tabpanel" aria-labelledby="address-tab">
             <div class="row">
              <%if(userAddress && userAddress.address.length > 0){%>
                <%userAddress.address.forEach((address)=>{%>
                <div class="col-lg-6">
                  <div class="card address-card mb-4">
                    <div class="card-header">
                      <h5 class="mb-0"><%=address.addressType%></h5>
                    </div>
                    <div class="card-body">
                      <address class="mb-2">
                        <strong><%=address.name%></strong><br>
                        <%=address.landMark%><br>
                        <%=address.city%>, <%=address.state%><br>
                        <%=address.pincode%>
                      </address>
                      <p>
                        <strong>Phone:</strong> <%=address.phone%><br>
                        <% if(address.altPhone) { %>
                          <strong>Alt Phone:</strong> <%=address.altPhone%>
                        <% } %>
                      </p>
                      <div class="action-buttons">
                        <a href="/editAddress?id=<%=address._id%>" class="btn btn-sm btn-outline-primary">Edit</a>
                        <a href="/deleteAddress?id=<%=address._id%>" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this address?')">Delete</a>
                      </div>
                    </div>
                  </div>
                </div>
                <%})%>
              <%} else {%> 
                <div class="col-12">
                  <div class="card">
                    <div class="card-body no-data">
                      <i class="fi-rs-marker-slash" style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
                      <h5>No Address Saved</h5>
                      <p>You haven't added any address yet</p>
                      <a href="/addAddress?returnTo=checkout" class="btn btn-primary mt-2">
                        Add New Address
                      </a>
                    </div>
                  </div>
                </div>
              <%}%> 
             </div>
             <%if(userAddress && userAddress.address.length > 0){%>
             <div class="text-end mt-3">
               <a href="/addAddress?returnTo=checkout" class="btn btn-primary">
                 <i class="fi-rs-plus mr-2"></i>Add New Address
               </a>
             </div>
             <%}%>
           </div>
 <!--order session-->
           
           <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
             <div class="card">
               <div class="card-header">
                 <h5 class="mb-0">Your Orders</h5>
               </div>
               <!--search-->
               <div class="d-flex justify-content-center mb-3" style="margin-top: 10px;">
                <form action="/userProfile#orders" method="get" class="w-50 d-flex">
                  <input
                    type="text"
                    name="search"
                    class="form-control me-2"
                    placeholder="Search by Order ID or Status"
                    value="<%= typeof search !== 'undefined' ? search : '' %>"
                  />
                  <button type="submit" class="btn btn-primary">Search</button>

                </form>
                <button class="btn btn-primary " style="margin-left: 10px;" ><a  style="color: white;"   href="/userProfile#orders">Clear</a></button>
              </div>
              

               <div class="card-body">
                 <div class="table-responsive">
                   <table class="table">
                     <thead>
                       <tr>
                        
                         <th>Order</th>
                         <th>Date</th>
                         <th>Status</th>
                         <th>Total</th>
                         <th>Payment Method</th>
                         <th>Actions</th>
                       </tr>
                     </thead>
                     <tbody>
                      <% if (orders && orders.length > 0) { %>
                        <% orders.forEach(order => { %>
                         
                            <tr>
                              <td>
                                <p><strong>#</strong> <%= order.orderId %></p>
                                <% order.items.forEach(item => { %>
                                  <img src="/uploads/product-images/<%= item.product.mainImage %>" alt="Product Image" width="100" />
                                <% }) %>
                              </td>
                               <td>  <%= new Date(order.date).toLocaleDateString() %></td>
                               <td><%=order.status%></td>

                               <td><%=order.total%></td>

                               <td> 
                                     <% if (order.payment === "cod") { %>
                                      <p>Cash on Delivery</p>
                                    <% }else if(order.payment==="wallet"){%>
                                      <p>Wallet</p>
                                    <%}else if(order.payment==="razorpay"){%> 
                                      <p>razerpay</p>
                                    <%}else{%>
                                      <p>Unknown payment</p>
                                    <%}%>    
                              </td>
                              <td>
                                <button class="btn btn-success"><a style="color: white;" href="/order-Details?orderId=<%=order.orderId%>">View Details</a></button>
                                <%if(order.status!=='Cancelled'&&order.status!=='Deliverd'){%>
                                  <button class="btn btn-danger" onclick="confirmCancelOrder(event, '<%= order.oid %>')">Cancel Order</button>


                                <%}%>
                              </td>
                            </tr>
                          
                        <% }) %>
                      <% }else{ %>
                       <tr>
                         <td colspan="4" class="text-center py-4">No orders found</td>
                       </tr>
                       <%}%>
                     </tbody>
                   </table>
                   <!--pagination for order session-->
                   <% if (totalPages > 1) { %>
                    <nav aria-label="Order pagination" class="mt-3">
                      <ul class="pagination justify-content-center">
                        <% for (let i = 1; i <= totalPages; i++) { %>
                          <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                            <a class="page-link" href="/userProfile?page=<%= i %><%= search ? '&search=' + search : '' %>#orders"><%= i %></a>
                          </li>
                        <% } %>
                      </ul>
                    </nav>
                  <% } %>
                  
                    
                 </div>
               </div>
             </div>
           </div>




    <!--wallet session-->
           <div class="tab-pane fade" id="track-orders" role="tabpanel" aria-labelledby="track-orders-tab">
             <div class="card">
               <div class="card-header">
                 <h5 class="mb-0">Wallet</h5>
               </div>
               <div class="card-body">
                 <div class="row">
                   <div class="col-lg-8 mx-auto text-center py-4">
                     <div class="display-4 mb-3">₹<%=user.wallet.balance%></div>
                     <a href="/wallet/addMoney">
                        <button type="button" class="btn btn-success px-4">
                          <i class="fi-rs-plus mr-2"></i>Add Money
                        </button>
                     </a>
                     
                   </div>
                 </div>
               </div>
             </div>
           </div>
      <!--wallet history session-->
           <div class="tab-pane fade" id="wallet-history" role="tabpanel" aria-labelledby="orders-tab">
             <div class="card">
               <div class="card-header">
                 <h5 class="mb-0">Wallet History</h5>
               </div>
               <div class="card-body">
                 <div class="table-responsive">
                   <table class="table">
                     <thead>
                       <tr>
                          <th colspan="3" class="text-center py-4">  Date</th>
                          <th colspan="3" class="text-center py-4"> Status</th>
                          <th colspan="3" class="text-center py-4"> Amount</th>
                       </tr>
                     </thead>
                     <tbody>
                      <%if(user.wallet){%>
                        <%paginationWallet.forEach((item)=>{%>
                          <tr>
                              <td colspan="3" class="text-center py-4"> <%= new Date(item.date).toLocaleDateString('en-GB').replace(/\//g, '-') %></td>
                              <td colspan="3" class="text-center py-4"><%=item.status%></td>
                              <td colspan="3" class="text-center py-4"><%=item.amount%></td>
                          </tr>
                        <%})%>
                      <%}else{%> 
                        <tr><td colspan="3" class="text-center py-4">No wallet history available</td></tr>
                      <%}%> 
                     </tbody>
                   </table>
                   <!--pagination for wallet histroy session-->
                   <% if (tpages > 1) { %>
                    <nav aria-label="Order pagination" class="mt-3">
                      <ul class="pagination justify-content-center">
                        <% for (let i = 1; i <= tpages; i++) { %>
                          <li class="page-item <%= walltCurrentPage === i ? 'active' : '' %>">
                            <a class="page-link" href="/userProfile?walltPage=<%= i %>#wallet-history"><%= i %></a>
                          </li>
                        <% } %>
                      </ul>
                    </nav>
                  <% } %>
                 </div>
               </div>
             </div>
           </div>

           <div class="tab-pane fade" id="referal" role="tabpanel" aria-labelledby="track-orders-tab">
             <div class="card">
               <div class="card-header">
                 <h5 class="mb-0">Referal Program</h5>
               </div>
               <div class="card-body">
                 <h6 class="mb-3">Refer your friends and earn money!</h6>
                 <div class="input-group mb-3">
                  <input type="text" class="form-control" value="<%=user.referralCode%>" id="referralCode" readonly>
                  <button class="btn btn-outline-secondary" type="button" onclick="copyReferralCode()">
                    <i class="fi-rs-copy"></i>
                  </button>
                </div>
                 <div class="input-group mb-3">
                   <input type="text" class="form-control" value="http://localhost:3006/signup?ref=<%=user.referralCode%>" id="referralLink" readonly>
                   <button class="btn btn-outline-secondary" type="button" onclick="copyReferralLink()">
                     <i class="fi-rs-copy"></i>
                   </button>
                 </div>
                 <div class="alert alert-info">
                   <strong>Earned:</strong> ₹<%= 50* user.referrCouponCount%>
                 </div>
               </div>
             </div>
           </div>
         </div>
       </div>
     </div>
   </div>
 </section>
</main>

<!-- Modal for change email -->
<div class="modal fade" id="edit-address-modal" tabindex="-1" aria-labelledby="simpleEmailModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Enter Existing Email</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="/change-email" method="POST" onsubmit="return validateChangeEmail()">
        <div class="modal-body">
          <div class="mb-3">
            <label for="emailInput" class="form-label">Email Address</label>
            <input type="email" name="email" class="form-control" id="emailInput" placeholder="example@email.com">
            <div id="emailError" class="invalid-feedback" style="display: none;"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="verifyButton">Verify</button>
        </div>
      </form>
    </div>
  </div>
</div>

<%- include("../../views/partials/user/footer") %>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  function validateChangeEmail() {
    const email = document.getElementById('emailInput').value;
    const emailError = document.getElementById('emailError');
    let isValid = true;
    
    emailError.style.display = "none";
    document.getElementById('emailInput').classList.remove('is-invalid');
    
    if(email.trim() === "") {
      emailError.textContent = "Email field is required";
      emailError.style.display = "block";
      document.getElementById('emailInput').classList.add('is-invalid');
      isValid = false;
    } else if(!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(email)) {
      emailError.textContent = "Please enter a valid email address";
      emailError.style.display = "block";
      document.getElementById('emailInput').classList.add('is-invalid');
      isValid = false;
    }
    
    return isValid;
  }
  
  function copyReferralLink() {
    const copyText = document.getElementById("referralLink");
    copyText.select();
    copyText.setSelectionRange(0, 99999);
    document.execCommand("copy");
    
    const originalText = copyText.value;
    copyText.value = "Copied!";
    setTimeout(() => {
      copyText.value = originalText;
    }, 2000);
  }

  function copyReferralCode() {
    const copyText = document.getElementById("referralCode");
    copyText.select();
    copyText.setSelectionRange(0, 99999);
    document.execCommand("copy");
    
    const originalText = copyText.value;
    copyText.value = "Copied!";
    setTimeout(() => {
      copyText.value = originalText;
    }, 2000);
  }


  function confirmCancelOrder(event,orderId) {
        event.preventDefault();
        Swal.fire({
            title: 'Are you sure?',
            text: "Do you really want to cancel this product?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#e74c3c',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, cancel it!'
        }).then((result) => {
            if (result.isConfirmed) {
                // Redirect to the cancel URL (GET request or can also be POST via AJAX)
                window.location.href = `/cancel-Order?orderId=${orderId}`;
            }
        });
    }


    document.addEventListener("DOMContentLoaded", function () {
    const hash = window.location.hash;

    if (hash) {
      const tabTriggerEl = document.querySelector(`a[href="${hash}"]`);
      if (tabTriggerEl) {
        const tab = new bootstrap.Tab(tabTriggerEl);
        tab.show(); // Activate the correct tab
      }
    }
  });

   
</script>
