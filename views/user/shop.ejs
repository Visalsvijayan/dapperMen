<%- include("../../views/partials/user/header") %>
<style>
 .main-container {
   max-width: 1200px;
   margin: 0 auto;
   padding: 20px;
 }
 .shop-topbar {
   display: flex;
   justify-content: space-between;
   align-items: center;
   margin-bottom: 20px;
 }


 .search-form {
   display: flex;
   align-items: center;
   background-color: #f1f1f1;
   border-radius: 25px;
   overflow: hidden;
   max-width: 250px;
   box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
 }


 .search-input {
   flex: 1;
   padding: 8px 10px;
   font-size: 14px;
   border: none;
   outline: none;
   background-color: transparent;
 }


 .search-button {
   padding: 8px 15px;
   background-color: #1e918b;
   color: #fff;
   border: none;
   cursor: pointer;
   font-size: 14px;
   border-radius: 15px;
   margin-right: 5px;
   transition: background-color 0.3s, transform 0.2s;
 }


 .search-button:hover {
   background-color: #0056b3;
   transform: scale(1.05);
 }
 .sidebar {
   padding: 20px;
   border: 1px solid #ddd;
   background-color: #f9f9f9;
   border-radius: 8px;
   margin-bottom: 20px;
   width: 250px;
   text-align: center;
 }


 .filter-section {
   margin-bottom: 20px;
 }


 .filter-title {
   font-weight: bold;
   margin-bottom: 10px;
   font-size: 16px;
   color: #333;
 }


 .filter-item {
   margin: 5px 0;
 }


 .filter-item a {
   text-decoration: none;
   color: #333;
 }


 .filter-item a:hover {
   color: #007bff;
 }


 .product-list-container {
   display: flex;
   gap: 20px;
 }


 .product-grid {
   display: flex;
   flex-wrap: wrap;
   gap: 20px;
   width: calc(100% - 270px);
 }


 .product-card {
   width: calc(33.333% - 20px);
   border: 1px solid #ddd;
   padding: 15px;
   border-radius: 8px;
   text-align: center;
   position: relative;
 }


 .product-card img {
   max-width: 100%;
   height: auto;
   border-radius: 5px;
 }


 .wishlist-btn {
   position: absolute;
   top: 8px;
   right: 8px;
   background-color: rgba(237, 247, 247, 0.8);
   color: #fff;
   padding: 8px;
   border-radius: 50%;
   cursor: pointer;
 }


 .add-to-cart-btn {
   background-color: #46698f;
   color: #fff;
   padding: 10px;
   border: none;
   border-radius: 5px;
   cursor: pointer;
   width: 100%;
   margin-top: 10px;
 }


 .pagination {
   display: flex;
   justify-content: center;
   gap: 10px;
   margin: 20px 0;
 }


 .pagination a {
   padding: 8px 12px;
   background-color: #f0f0f0;
   border: 1px solid #ddd;
   color: #333;
   text-decoration: none;
 }


 .pagination .active {
   background-color: #007bff;
   color: #fff;
 }


 .price-filter {
   padding: 10px;
   background-color: #f9f9f9;
   border-radius: 8px;
   margin-top: 20px;
 }


 .price-filter .price-options {
   display: flex;
   flex-direction: column;
   gap: 10px;
 }


 .price-button {
   padding: 12px 20px;
   background-color: #f1f1f1;
   color: #333;
   border: 1px solid #ddd;
   border-radius: 30px;
   cursor: pointer;
   transition: background-color 0.3s, transform 0.2s;
   text-align: center;
   font-size: 14px;
 }


 .price-button:hover {
   background-color: #007bff;
   color: white;
   transform: scale(1.05);
 }


 .price-button:active {
   transform: scale(0.95);
 }


 /* .category-brand-container {
   text-align: center;
 } */


 
 .sort-dropdown {
    margin-left: auto;
  }
  
  .sort-select {
    padding: 8px 12px;
    border-radius: 4px;
    border: 1px solid #ddd;
    background-color: #f9f9f9;
    cursor: pointer;
  }
  
  .shop-topbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
  }
  .category-brand-container {
  margin-left: 0;  /* Reset any offset */
  padding: 0;
  text-align: left; /* Align text to left */
}
.sidebar ul {
  padding-left: 70px;
  margin-left: 0;
}
/*for responsive*/
@media (max-width: 768px) {
  .shop-topbar {
    flex-direction: column;
    align-items: stretch;
    gap: 10px;
  }

  .search-form {
    width: 100%;
    max-width: 100%;
  }

  .sort-dropdown {
    width: 100%;
    margin-left: 0;
  }

  .sort-select {
    width: 100%;
  }

  .product-list-container {
    flex-direction: column;
  }

  .sidebar {
    width: 100%;
    margin-bottom: 20px;
  }

  .product-grid {
    width: 100%;
    gap: 15px;
    justify-content: center;
  }

  .product-card {
    width: 100%;
    max-width: 300px;
    margin: 0 auto;
  }

  .price-button {
    width: 100%;
  }

  .pagination {
    flex-wrap: wrap;
    gap: 8px;
  }

  .pagination a {
    flex: 1;
    text-align: center;
  }

  .wishlist-btn {
    top: 10px;
    right: 10px;
  }
}
 
</style>


<div class="main-container">
 <section class="shop-page container">
   <div class="shop-topbar">
     <div class="search-bar">
        
       
       <div class="shop-topbar">
        <div class="search-bar">
           
          <form action="/filter" method="GET" class="search-form">
            <input 
              type="text" 
              name="query" 
              placeholder="Search items..." 
              class="search-input" 
              value="<%= query || '' %>"
            />
            <!-- Preserve current filters as hidden fields -->
            <input type="hidden" name="category" value="<%= selectedCategory || '' %>">
            <input type="hidden" name="brand" value="<%= selectedBrand || '' %>">
            <input type="hidden" name="gt" value="<%= priceRange?.gt || '' %>">
            <input type="hidden" name="lt" value="<%= priceRange?.lt || '' %>">
            <input type="hidden" name="sort" value="<%= currentSort || '' %>">
            <button type="submit" class="search-button">Search</button>
          </form>
        </div>
        
        <!--  sorting dropdown -->
        <div class="sort-dropdown">
          <form id="sort-form" method="GET" action="/filter">
            <!-- Include all current filters -->
            <input type="hidden" name="query" value="<%= query || '' %>">
            <input type="hidden" name="category" value="<%= selectedCategory || '' %>">
            <input type="hidden" name="brand" value="<%= selectedBrand || '' %>">
            <input type="hidden" name="gt" value="<%= priceRange?.gt || '' %>">
            <input type="hidden" name="lt" value="<%= priceRange?.lt || '' %>">
            
            <select name="sort" onchange="this.form.submit()" class="sort-select">
              <option value="newest" <%= currentSort === 'newest' ? 'selected' : '' %>>Newest Arrivals</option>
              <option value="price-low-high" <%= currentSort === 'price-low-high' ? 'selected' : '' %>>Price: Low to High</option>
              <option value="price-high-low" <%= currentSort === 'price-high-low' ? 'selected' : '' %>>Price: High to Low</option>
              <option value="oldest" <%= currentSort === 'oldest' ? 'selected' : '' %>>Oldest First</option>
            </select>
          </form>
        </div>
      </div>
       
      
     </div>
   </div>
  
   <div class="product-list-container">
     <aside class="sidebar">
      <a href="/shop" class="btn btn-secondary mt-3">Clear Filters</a><br><br>
       <div class="filter-section">
         <div class="filter-title">Categories</div>
         <div class="category-brand-container">
           <ul>
        

            <%for(let i=0;i<category.length; i++){%>
              <li class="filter-item">
                <a href="/filter?category=<%=category[i]._id%><%= selectedBrand ? `&brand=${selectedBrand}` : '' %><%= priceRange?.gt ? `>=${priceRange.gt}` : '' %><%= priceRange?.lt ? `<=${priceRange.lt}` : '' %><%= currentSort ? `&sort=${currentSort}` : '' %>">
                  <%=category[i].name%>
                </a>
              </li>
            <%}%>
             
           </ul>
         </div>
       </div>


      
       <div class="filter-section">
         <div class="filter-title">Brands</div>
         <div class="category-brand-container">
           <ul>
             
            <%for(let i=0;i<brand.length; i++){%>
              <li class="filter-item">
                <a href="/filter?brand=<%=brand[i]._id%><%= encodeURIComponent(query) ? `&query=${encodeURIComponent(query)}` : '' %><%= selectedCategory ? `&category=${selectedCategory}` : '' %><%= priceRange?.gt ? `&gt=${priceRange.gt}` : '' %><%= priceRange?.lt ? `&lt=${priceRange.lt}` : '' %><%= currentSort ? `&sort=${currentSort}` : '' %>">
                  <%=brand[i].brandName%>
                </a>
              </li>
            <%}%>
            
           </ul>
         </div>
       </div>


      
       <div class="price-filter">
         <div class="filter-title">Filter by Price</div>
         <form id="price-filter-form">
            
           <div class="price-options">
            <a href="/filter?gt=0&lt=500<%= query ? `&query=${query}` : '' %><%= selectedCategory ? `&category=${selectedCategory}` : '' %><%= selectedBrand ? `&brand=${selectedBrand}` : '' %><%= currentSort ? `&sort=${currentSort}` : '' %>">
              <button type="button" class="price-button">Under ₹500</button>
            </a>
            <!-- Other price range buttons with same parameters -->
            <a href="/filter?gt=500&lt=1000<%= query ? `&query=${query}` : '' %><%= selectedCategory ? `&category=${selectedCategory}` : '' %><%= selectedBrand ? `&brand=${selectedBrand}` : '' %><%= currentSort ? `&sort=${currentSort}` : '' %>">
              <button type="button" class="price-button">Under ₹1000</button>
            </a>
            <a href="/filter?gt=1000&lt=1500<%= query ? `&query=${query}` : '' %><%= selectedCategory ? `&category=${selectedCategory}` : '' %><%= selectedBrand ? `&brand=${selectedBrand}` : '' %><%= currentSort ? `&sort=${currentSort}` : '' %>">
              <button type="button" class="price-button">Under ₹1500</button>
            </a>
            <a href="/filter?gt=1500&lt=10000<%= query ? `&query=${query}` : '' %><%= selectedCategory ? `&category=${selectedCategory}` : '' %><%= selectedBrand ? `&brand=${selectedBrand}` : '' %><%= currentSort ? `&sort=${currentSort}` : '' %>">
              <button type="button" class="price-button">Under ₹10000</button>
            </a>
          </div>

         </form>
       </div>
       
       
     </aside>

   <!--product image and other things-->
     <main class="product-grid">
        <%for(let i=0;i<products.length;i++){%>
         <div class="product-card">
           
          <% if (user) { %>
              <% if (user.wishlist.includes(products[i]._id)) { %>
                <span class="wishlist-btn" onclick="addToWishlist('<%= products[i]._id %>', this)">
                  <i class="fas fa-heart" style="color: red;"></i>
                </span>
              <% } else { %>
                <span class="wishlist-btn" onclick="addToWishlist('<%= products[i]._id %>', this)">
                  <i class="far fa-heart" style="color: grey;"></i>
                </span>
              <% } %>
          <% } else { %>
            <span class="wishlist-btn" onclick="location.href='/login'">
              <i class="far fa-heart" style="color: grey;"></i>
            </span>
          <% } %>


           
           <a href="/productDetails?id=<%=products[i]._id%>">
             <img src="/uploads/product-images/<%=products[i].productImage[0]%>" alt="<%=products[i].productName%>" >
             <h4><%=products[i].productName%></h4>
             <p><%=products[i].brand%></p>
             <p>Price: ₹<%=products[i].salePrice.toLocaleString('en-IN')%> <span class="text-muted"><strike>₹ <%=products[i].regularPrice.toLocaleString('en-IN')%></strike></span></p>
           </a>
           <%if(user){%>
              <button class="add-to-cart-btn" onclick="addToCart('<%=products[i]._id%>')">Add to Cart</button>
           <%}else{%>
              <button class="add-to-cart-btn" onclick="location.href='/login'">Add to Cart</button>
           <%}%>

         </div>
         <%}%>
     </main>
   </div>


<!-- Pagination -->
    
    <div class="pagination">
      <% if (currentPage > 1) { %>
        <a class="btn" href="/filter?page=<%= currentPage - 1 %><%= query ? `&query=${query}` : '' %><%= selectedCategory ? `&category=${selectedCategory}` : '' %><%= selectedBrand ? `&brand=${selectedBrand}` : '' %><%= priceRange?.gt ? `&gt=${priceRange.gt}` : '' %><%= priceRange?.lt ? `&lt=${priceRange.lt}` : '' %><%= currentSort ? `&sort=${currentSort}` : '' %>">Prev</a>
      <% } %>
    
      <% for (let i = 1; i <= totalPages; i++) { %>
        <a class="btn <%= currentPage === i ? 'active' : '' %>" href="/filter?page=<%= i %><%= query ? `&query=${query}` : '' %><%= selectedCategory ? `&category=${selectedCategory}` : '' %><%= selectedBrand ? `&brand=${selectedBrand}` : '' %><%= priceRange?.gt ? `&gt=${priceRange.gt}` : '' %><%= priceRange?.lt ? `&lt=${priceRange.lt}` : '' %><%= currentSort ? `&sort=${currentSort}` : '' %>"><%= i %></a>
      <% } %>
    
      <% if (currentPage < totalPages) { %>
        <a class="btn" href="/filter?page=<%= currentPage + 1 %><%= query ? `&query=${query}` : '' %><%= selectedCategory ? `&category=${selectedCategory}` : '' %><%= selectedBrand ? `&brand=${selectedBrand}` : '' %><%= priceRange?.gt ? `&gt=${priceRange.gt}` : '' %><%= priceRange?.lt ? `&lt=${priceRange.lt}` : '' %><%= currentSort ? `&sort=${currentSort}` : '' %>">Next</a>
      <% } %>
    </div>
  
 </section>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<%- include("../../views/partials/user/footer") %>

<script>
   async function addToCart(id) {
  try {
    // Show loading alert
    Swal.fire({
      title: 'Adding to Cart',
      text: 'Please wait...',
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });

    const response = await fetch('/add-to-cart', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({id})
    });

    const result = await response.json();

    // Close loading alert
    Swal.close();

    if (result.success === true) {
      // Success Alert
      Swal.fire({
        icon: 'success',
        title: 'Added to Cart!',
        text: 'Item was added successfully',
        showConfirmButton: false,
        timer: 1500
      });
      
      // Update cart count in UI (if you have one)
      const cartCountElement = document.querySelector('.cart-count');
      if (cartCountElement) {
        cartCountElement.textContent = result.cartLength;
      }
    } 
    else if (result.status ===false) {
      // Out of stock Alert
      Swal.fire({
        icon: 'error',
        title: status,
         
      });
    }
    else {
      // Generic error Alert
      Swal.fire({
        icon: 'error',
        title: 'Failed',
        text: result.status || 'Could not add to cart',
      });
    }
  } 
  catch (error) {
    Swal.close();
    Swal.fire({
      icon: 'error',
      title: 'Network Error',
      text: 'Failed to connect to server',
    });
    console.error('Error:', error);
  }
}


async function addToWishlist(productId,element) {
  try {
    const icon = element.querySelector('i');

    const res=await fetch(`/wishlist/toggle/${productId}`,{
      method:'POST',
      headers:{
        'content-Type':'application/json'
      }
    })
    const result=await res.json();
    if(result.status==='added'){
      // alert('added')
      
      icon.classList.remove('far');
      icon.classList.add('fas');
      icon.style.color='red';


    }
    else{
     icon.classList.remove('fas');
     icon.classList.add('far');
     icon.style.color='grey';

    }
  } catch (error) {
    alert('something went wrong')
    
  }
  
}
</script>
